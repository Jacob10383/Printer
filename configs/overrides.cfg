#═══════════════════════════════════════════════════════════════════════════════
#  TOOLCHANGER
#═══════════════════════════════════════════════════════════════════════════════
[toolchanger]
flush_speed: 20              # mm³/s volumetric flow rate
pre_flush_speed: 15          # mm³/s for pre-flush extrusion
pre_flush_length: 50         # mm to extrude before flush
default_temp: 220            # fallback temp when no gcode data
retract_length: 45           # mm to retract before cutting
spoolman_integration: true  # enable spoolman spool tracking
#═══════════════════════════════════════════════════════════════════════════════
#  CARTOGRAPHER & BED MESH
#═══════════════════════════════════════════════════════════════════════════════
[cartographer scan_model default]
coefficients: 1.558973710323948,2.05966354421173,0.8390662963753031,0.36826588347617645,0.404478262945476,0.3702382301637983,-0.22263172398155204,-0.24537561517376447,0.2208631751773589,0.15447885511683312
domain: 3.3267938494070614e-07,3.4175762455740445e-07
z_offset: 0
reference_temperature: 50.34
software_version: 1.3.3
mcu_version: CARTOGRAPHER V4 6.0.0
[cartographer touch_model default]
threshold: 950
speed: 1.0
z_offset: -0.05
software_version: 1.3.3
mcu_version: CARTOGRAPHER V4 6.0.0
[bed_mesh]
probe_count: 150,50
mesh_min: 10,10
mesh_max: 335,335
adaptive_margin: 10
move_check_distance: 3
speed: 200
[bed_mesh default]
version: 1
points:
    0.0, 0.0, 0.0, 0.0, 0.0
    0.0, 0.0, 0.0, 0.0, 0.0
    0.0, 0.0, 0.0, 0.0, 0.0
    0.0, 0.0, 0.0, 0.0, 0.0
    0.0, 0.0, 0.0, 0.0, 0.0
x_count: 5
y_count: 5
mesh_x_pps: 2
mesh_y_pps: 2
algo: bicubic
tension: 0.2
min_x: 5.0
max_x: 345.0
min_y: 5.0
max_y: 335.0
#═══════════════════════════════════════════════════════════════════════════════
#  FILAMENT Z OFFSETS
#═══════════════════════════════════════════════════════════════════════════════
[gcode_macro _START_PRINT_VARS]
variable_heat_soak: 0  # minutes
variable_offset_PETG: 0.075
variable_offset_ABS: 0
variable_offset_ASA: 0
variable_offset_TPU: 0.025
variable_offset_PLA: 0.075
variable_offset_DEFAULT: 0.075
gcode:
#═══════════════════════════════════════════════════════════════════════════════
#  INPUT SHAPER & AXIS TUNING
#═══════════════════════════════════════════════════════════════════════════════
[input_shaper]
# X-axis: smooth_zv @ 54.8 Hz (vibration: 0.00%, max_accel: 10800 mm/sec²)
shaper_type_x: smooth_zv
smoother_freq_x: 45.6
# Y-axis: smooth_zv @ 45.6 Hz (vibration: 0.01%, max_accel: 7200 mm/sec²)
shaper_type_y: smooth_zv
smoother_freq_y: 45.6
[axis_twist_compensation]
z_compensations: 0.042265, -0.011381, -0.009921, -0.027894, 0.006931
compensation_start_x: 5.0
compensation_end_x: 345.0
#═══════════════════════════════════════════════════════════════════════════════
#  TEMPERATURE CONTROL
#═══════════════════════════════════════════════════════════════════════════════
[extruder]
control: pid
pid_kp: 26.157
pid_ki: 2.813
pid_kd: 60.815
[heater_bed]
control: pid
pid_Kp: 45.512
pid_Ki: 1.331
pid_Kd: 389.129
#═══════════════════════════════════════════════════════════════════════════════
#  MISC
#═══════════════════════════════════════════════════════════════════════════════
[virtual_sdcard]
forced_leveling: false
[box]
cut_pos_x: -7.30
[gcode_macro PRINTER_PARAM]
variable_max_y_position: 380.0
#═══════════════════════════════════════════════════════════════════════════════
#  HOMING
#═══════════════════════════════════════════════════════════════════════════════
[homing_override]
axes: xyz
gcode:
  MOTOR_STALL_MODE DATA=1
  M204 S500

  {% set homed = printer.toolhead.homed_axes %}

  # Reset ready variables if nothing is homed
  {% if homed|length == 0 %}
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=x_ready VALUE=0
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=y_ready VALUE=0
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_ready VALUE=0
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=xy_moved VALUE=0
    SET_GCODE_VARIABLE MACRO=xyz_ready VARIABLE=z_moved VALUE=0
    {action_respond_info("No axes homed")}
  {% else %}
    {action_respond_info("Homed axes: %s" % homed)}
  {% endif %}

  # Clear bed mesh if Z not yet homed
  {% if 'z' not in homed %}
    BED_MESH_CLEAR
  {% endif %}

  # Determine what needs homing
  {% set home_all = 'X' not in params and 'Y' not in params %}

  # G28 Z with X/Y already homed: skip re-homing X/Y
  {% if 'Z' in params and 'X' not in params and 'Y' not in params and 'x' in homed and 'y' in homed %}
    {% set home_all = false %}
  {% endif %}

  {% set x_homing = home_all or 'X' in params %}
  {% set y_homing = home_all or 'Y' in params %}

  # Home Y then X
  {% if y_homing %}
    _HOME_Y
  {% endif %}

  {% if x_homing %}
    _HOME_X
  {% endif %}

  # Back off Y if both X and Y end up homed after this operation
  {% set x_homed_after = x_homing or 'x' in homed %}
  {% set y_homed_after = y_homing or 'y' in homed %}
  {% if (x_homing or y_homing) and x_homed_after and y_homed_after %}
    FORCE_MOVE STEPPER=stepper_y DISTANCE=-3 VELOCITY=10
  {% endif %}

  # Home Z
  {% if home_all or 'Z' in params %}
    SET_PIN PIN=extruder_fan VALUE=0
    _HOME_Z
  {% endif %}

  BED_MESH_PROFILE LOAD="default"
  MOTOR_STALL_MODE DATA=2
  MOTOR_CHECK_PROTECTION_AFTER_HOME DATA=11
  M204 S{printer.toolhead.max_accel}
