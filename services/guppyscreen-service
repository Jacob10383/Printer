#!/bin/sh /etc/rc.common

START=01
STOP=99
USE_PROCD=1

GUPPY_DIR="/mnt/UDISK/root/guppyscreen"
GUPPYSCREEN="$GUPPY_DIR/guppyscreen"
export GUPPY_DIR

start_service() {
    echo "Starting GuppyScreen from $GUPPY_DIR..."
    killall -9 boot-play 2>/dev/null

    procd_open_instance
    procd_set_param command "$GUPPYSCREEN"
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance

    # Inject fake touch events after 15 seconds to wake screen
    (
        sleep 15 && \
        echo -ne '\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x4a\x01\x01\x00\x00\x00' > /dev/input/event0 && \
        echo -ne '\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' > /dev/input/event0
    ) &
}

stop_service() {
    echo "Stopping GuppyScreen..."
    pgrep -x guppyscreen >/dev/null && killall -9 guppyscreen 2>/dev/null || true
}
